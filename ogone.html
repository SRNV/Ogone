<html>
  <head> 
      %%styles%%
      <script>
          const Ogone = {
            render: [],
            events: [],
            styles: [],
            templates: {},
          };
        function NodeManager(component, node, opts) {
          this.state = 3;
            /*
              3 created
              2 paused
              1 node has parentNode
              0 dead
            */
          this.type = opts.type;
          this.isRootNode = !opts.querySelector.length;
          this.parentId = opts.parentId;
          this.templateId = opts.templateId;
          this.templateUuid = opts.templateUuid;
          this.querySelector = opts.querySelector;
          this.uuid = opts.uuid;
          this.component = component;
          this.node = node;
          this.nodes = [node];
          this.array = opts.array;
          this.componentUuid = opts.componentUuid;
          this.placeholder = new Comment('');
          this.position = `${this.parentId} [${this.uuid}]`;
          this.texts = {};
          if (this.isRootNode) {
            this.component.nms.root = this;
          } else {
            this.component.nms[`${this.parentId} [${this.uuid}]`] = this;
          }
        }
        NodeManager.prototype.render = function() {
          if (this.state !== 1 || this.component.arrays[this.querySelector] === undefined) return;
          while (this.nodes.length > this.component.arrays[this.querySelector]) {
            if (this.nodes.length === 1) {
              const firstEl = this.nodes[0];
              if (firstEl) {
                const { parentNode } = firstEl;
                parentNode.insertBefore(this.placeholder, firstEl);
              }
            }
            const removedEl = this.nodes.pop();
            removedEl.remove();
          }
          if (this.nodes.length < this.component.arrays[this.querySelector]) {
            if (this.nodes.length === 1) {
              this.nodes[0].replaceWith(this.placeholder);
              this.nodes.shift();
            }
          }
          while (this.nodes.length < this.component.arrays[this.querySelector]) {
            Ogone.templates[`${this.templateId}`](this.component, {
              nodeManager: this,
              hasNodeManager: false, 
              index: this.nodes.length,
              parentId: this.parentId,
              callback: (el, uuid) => {
                if (this.nodes.length === 0) {
                  this.placeholder.replaceWith(el);
                } else {
                  this.nodes[this.nodes.length-1].insertAdjacentElement('afterend', el);
                }
                this.nodes.push(el);
                this.component.nms[`${this.parentId} [${uuid}]`] = this;
              }, 
            });  
          }
        }
        NodeManager.prototype.addEventListeners = function() {
        }
        NodeManager.prototype.update = function() {
          // manage NM states and force render
          switch(true) {
            case this.state === 3 /* created */
              && !this.isRootNode:
              this.state = 1; /* inserted */
              this.render();
              this.getTexts();
              this.addEventListeners();
            break;
            case this.state === 1 && !this.isRootNode:
              this.render();
            break;
          }
        }
        NodeManager.prototype.getTexts = function() {
          // get nm text
          Object.entries(this.texts).forEach(([key, textnode]) => {
            const text = this.component.texts[key];
            if (text && text.value !== textnode.data) {
              textnode.data = text.value;
            }
          })
        }
      </script>
      %%scripts%%
  </head>
  <body>
    <div id="app"></div>
    <script>
      const host = location.host;
      const components = {};
      function OComponent(ws) {
        this.ws = ws;
        this.contexts = {};
        this.context = {};
        this.nms = {}; /* NodeManager{} */
        this.events = {}; /* events describers */
        this.arrays = {}; /* data describer o-for */
        this.send = (json) => {
          this.ws.send(JSON.stringify(json));
        };
        this.directRenders = {};
        this.texts = [];
        this.read = (ev) => {
          switch(ev.type) {
            case 'component':
                this.rootNode = document.querySelector(`${ev.querySelector}:not([${ev.attr}])`);
                this.id = ev.id;
                this.send({ type: 'load', id: this.id });
                this.render(ev);
              break;
            case 'text':
              this.renderText(ev);
              break;
            case 'array':
              this.useArray(ev);
              break;
            case 'render':
              this.renderDirectRender(ev);
              break;
            case 'events':
              this.renderEvents(ev)
              break;
            case 'bind':
              this.renderBindEvent(ev);
            case 'context':
              this.readContext(ev);
              break;
            case 'render-context':
              this.renderContext(ev);
              break;
          }
        }
        this.update = () => {
          const nms = Object.values(this.nms);
          nms.filter((nm) => nm.state).reverse().forEach((nm) => {
            nm.update();
          });
        }
        this.useArray = (ev) => {
          this.arrays[ev.querySelector] = ev.length;
        };
        this.readContext = (ev) => {
          if (this.contexts.has(ev.querySelector)) {
            const item = this.contexts.get(ev.querySelector);
            item.length = ev.length;
          } else {
            this.contexts.set(ev.querySelector, ev);
          }
        }
        this.renderContext = (item) => {
          if (!item) return;
          if (this.rootNode) {
            if (!this.contexts[item.templateQuerySelector]) {
              this.contexts[item.templateQuerySelector] = {
                nodes: [],
                placeholder: new Comment('')
              };
            }
            const context = this.contexts[item.templateQuerySelector];
            while (context.nodes.length > item.length) {
              if (context.nodes.length === 1) {
                const firstEl = context.nodes[0];
                if (firstEl) {
                  const { parentNode } = firstEl;
                  parentNode.insertBefore(context.placeholder, firstEl);
                }
              }
              const removedEl = context.nodes.pop();
              removedEl.remove();
            }
            if (!item.length) return;
            this.rootNode.every((child) => {
              const parentNode = item.parentId.length ? child.querySelector(item.parentId) : child;
              if (parentNode) {
                const query = `${item.idElement}-${item.index}`;
                const [ newel ] = this.renderElements(item.html);
                newel.setAttribute(query, '');
                const alreadyRendered = parentNode.querySelector(item.querySelector);
                if (!alreadyRendered) {
                  const temp = parentNode.querySelector(item.templateQuerySelector);
                  if (temp && temp.parentNode && item.length === 0) {
                    temp.replaceWith(context.placeholder);
                    return;
                  }
                  if (item.index === 0) {
                    if (temp) {
                      temp.replaceWith(newel);
                      context.nodes[item.index] = newel;
                    } else {
                      context.placeholder.replaceWith(newel);
                      context.nodes[item.index] = newel;
                    }
                  }
                  if (context.nodes[item.index-1] && item.index !== 0) {
                    const el = context.nodes[item.index-1];
                    el.insertAdjacentElement('afterend', newel);
                    context.nodes[item.index] = newel;
                  }
                } else if (alreadyRendered.outerHTML !== newel.outerHTML) {
                  alreadyRendered.replaceWith(newel);
                  context.nodes[item.index] = newel;
                }
                return;
              }
            })
          }
        };
        this.renderBindEvent = (ev) => {
          const el = this.rootNode.querySelector(ev.querySelector);
          if (el && el.value !== ev.value) {
            el.value = ev.value;
          }
        };
        this.renderElements = (html) => {
          const template = document.createElement('template');
          template.insertAdjacentHTML('beforeend', html);
          return Array.from(template.childNodes).filter((c) => c.nodeType !== 3);
        };
        this.render = (item) => {
          if (!item) return;
          if (item.html && this.rootNode) {
            this.rootNode.innerHTML = '';
            Ogone.templates[item.attr](this, {
              hasNodeManager: true,
              NodeManager: null,
              index: 0,
              callback: (template) => {
                this.rootNode.replaceWith(...template.childNodes);
              },
            });
            this.update();
            this.send({
              type: 'o-inserted',
              id: this.id,
            });
          }
        }
        this.renderText = (item) => {
          if (!item) return;
          this.texts[item.position] = item;
        }
        this.setTextOfNode = (node) => {
          const texts = this.texts.filter((text) => node.matches(text.querySelector));
          if (texts.length) {
            node.childNodes.forEach((c, id) => {
              if (c.nodeType !== 3) return;
              const item =  texts.find((text) => text.textId === id);
              if (item) {
                let textNode = node.childNodes[id];
                if (item.value && textNode.data !== item.value) {
                  textNode.data = item.value;
                }
                return;
              }
            })
          }
        };
        this.renderDirectRender = (item) => {
          if (!item) return;
          if (this.directRenders[item.id2]) {
            const newel = this.renderElements(item.html)[0];
            this.directRenders[item.id2].replaceWith(newel);
            this.directRenders[item.id2] = newel;
            return;
          }
          if (item.querySelector === null) {
            const el = this.rootNode[0];
            const newel = this.renderElements(item.html)[0];
            el.replaceWith(newel);
            this.directRenders[item.id2] = newel;
            this.rootNode.slice(1).forEach((c) => c.remove());
            return;
          }
          this.rootNode.every((child) => {
            const el = child.querySelector(item.querySelector);
            if (el) {
              const newel = this.renderElements(item.html)[0];
              el.replaceWith(newel);
              this.directRenders[item.id2] = newel;
              return;
            }
          })
        }
        this.renderEvents = (item) => {
          if (!item) return;
          if (item.events.length) {
            item.events.forEach((event) => {
              const { querySelector } = event;
              if (!this.events[querySelector]) this.events[querySelector] = [];
              this.events[querySelector].push(event);
            });
          }
        };
      }
    </script>
    <script>
      const $APPWS_REPLACED_VAR$___ = new WebSocket(`ws://${host}/%%id%%`);
      $APPWS_REPLACED_VAR$___.onopen = () => {
        $APPWS_REPLACED_VAR$___.send(JSON.stringify({ type: 'load' }));
      };
      $APPWS_REPLACED_VAR$___.onclose = () => {
        location.reload();
      };
      $APPWS_REPLACED_VAR$___.onmessage = (event) => {
        if ($APPWS_REPLACED_VAR$___.readyState !== 1) return;
        if (event.data === 'reload') {
          location.reload();
          return;
        }
        const ev = JSON.parse(event.data);
        if (ev.id) {
          if (ev.id in components) {
            components[ev.id].read(ev); 
          } else {
            const oc = new OComponent($APPWS_REPLACED_VAR$___);
            oc.read(ev);
            components[ev.id] = oc;
          }
        }
      };
    </script>
  </body>
</html>