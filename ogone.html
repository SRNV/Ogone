<html>
  <head> 
      %%styles%%
  </head>
  <body>
    <div id="app"></div>
    <script>
      const host = location.host;
      function OComponent() {
        this.contexts = {};
        this.context = {};
        this.nms = {}; /* NodeManager{} */
        this.events = {}; /* events describers */
        this.arrays = {}; /* data describer o-for */
        this.directRenders = {};
        this.texts = [];
        this.read = (ev) => {
          switch(ev.type) {
            case 'component':
                this.rootNode = ev.node || document.querySelector(`${ev.querySelector}:not([${ev.attr}])`);
                this.id = ev.id;
                this.render(ev);
                let gen = this.runtime();
                gen.next();
                const v = gen.next('init');
                Object.seal(this.data);
                const w = gen.next('mounted');
                const watchers = gen.next();
              break;
          }
        }
        this.update = (dependency) => {
          const nms = Object.values(this.nms);
          nms.filter((nm) => nm.state).reverse().forEach((nm) => {
            nm.update(dependency);
          });
        }
        this.render = (item) => {
          if (!item) return;
          if (this.rootNode) {
            Ogone.templates[item.attr](this, {
              ...item,
              hasNodeManager: true,
              parentNodeManager: item.parentNodeManager || this,
              nodeManager: null,
              index: 0,
              level: 0,
              position: [0],
              querySelector: this.id,
              callback: (template) => {
                this.rootNode.replaceWith(...template.childNodes);
              },
            });
            this.update(true);
          }
        }
        this.renderElements = (html) => {
          const template = document.createElement('template');
          template.insertAdjacentHTML('beforeend', html);
          return Array.from(template.childNodes).filter((c) => c.nodeType !== 3);
        };
        this.renderDirectRender = (item) => {
          if (!item) return;
          if (this.directRenders[item.id2]) {
            const newel = this.renderElements(item.html)[0];
            this.directRenders[item.id2].replaceWith(newel);
            this.directRenders[item.id2] = newel;
            return;
          }
          if (item.querySelector === null) {
            const el = this.rootNode[0];
            const newel = this.renderElements(item.html)[0];
            el.replaceWith(newel);
            this.directRenders[item.id2] = newel;
            this.rootNode.slice(1).forEach((c) => c.remove());
            return;
          }
          this.rootNode.every((child) => {
            const el = child.querySelector(item.querySelector);
            if (el) {
              const newel = this.renderElements(item.html)[0];
              el.replaceWith(newel);
              this.directRenders[item.id2] = newel;
              return;
            }
          })
        }
        this.dr = (ref, html) => {
          try {
            if (ref.length && !this.refs[ref]) {
              return;
            }
            const querySelector = this.refs[ref] || false;
            let result = html;
            if (Array.isArray(html)) {
              result = html.join('');
            }
            if (html instanceof Function) {
              result = html();
            }
            const oElementId = `o-${(querySelector || '').trim().replace(/([^a-zA-Z0-9]*)+/gi, '') || ''}-rd`;
            this.renderDirectRender({
              id2: oElementId,
              html: result.replace(/%%id%%/gi, `${this.id} ${oElementId}`),
              querySelector: !!querySelector ? 
                `[${this.nms.root.templateId}][${this.id}] > ${querySelector.trim()}`:
                null,
              type: 'render',
              id: this.id,
            });
          } catch(e) {
            throw e;
          }
        };
        this.h = (name, attr, ...childs) => {
          try {
            let attrs = [];
            if (attr) {
              attrs = Object.entries(attr).map(([key, value]) => {
                if (key.startsWith('$')) {
                  return;
                }
                return `${key}="${value}"`
              })
            }
            const element = `<${name} %%id%% ${this.uuid} ${attrs.join(' ')}>${childs.flat().join(' ')}</${name}>`
            // direct rendering with $$ references
            if (attr) {
              const ref = Object.keys(attr).find((key) => key.startsWith('$'));
              if (ref) {
                const id = ref.slice(1);
                this.dr(id, element);
                return id;
              }
            }
            return element;
          } catch(e) {
            throw e;
          }
        };
      }

    </script>
    <script>
        const Ogone = {
          render: [],
          events: [],
          styles: [],
          templates: {},
          texts: [],
          contexts: {},
          components: {},
        };
    </script>
    <script>
      function NodeManager(component, node, opts) {
        this.state = 3;
          /*
            3 created
            2 paused
            1 node has parentNode
            0 dead
          */
        this.type = opts.type;
        this.isRootNode = !opts.querySelector.length;
        this.parentId = opts.parentId;
        this.templateId = opts.templateId;
        this.templateUuid = opts.templateUuid;
        this.querySelector = opts.querySelector;
        this.uuid = opts.uuid;
        this.component = component;
        this.node = node;
        this.nodes = [node];
        this.array = opts.array;
        this.componentUuid = opts.componentUuid;
        this.placeholder = new Comment('');
        this.position = `${this.parentId} [${this.uuid}]`;
        this.texts = {};
        this.getContext = null;
        this.tree = opts.position;
        this.level = opts.level;
        this.positions = {};
        this.amount = 1;
        this.childs = [];
        this.parentNodeManager = opts.parentNodeManager;
        this.requirement = opts.requirement;
        this.props = opts.props;
        this.dependencies = opts.dependencies;
        if (this.isRootNode) {
          this.component.nms.root = this;
        } else {
          if (this.component.nms[this.position]) {
            this.component.nms[this.position].state = 0
          }
          this.component.nms[this.position] = this;
        }
      }
      NodeManager.prototype.render = function() {
        if (this.state !== 1 || this.amount === undefined) return;
        for (let i = this.nodes.length, a = this.amount; i > a; i--) {
          if (this.nodes.length === 1) {
            const firstEl = this.nodes[0];
            if (firstEl) {
              const { parentNode } = firstEl;
              parentNode.insertBefore(this.placeholder, firstEl);
            }
          }
          const removedEl = this.nodes.pop();
          removedEl.remove();
        }
        if (this.nodes.length < this.amount) {
          if (this.nodes.length === 1) {
            this.nodes[0].replaceWith(this.placeholder);
            this.nodes[0].remove();
            this.nodes.shift();
          }
        }
        for (let i = this.nodes.length, a = this.amount;i < a; i++) {
          Ogone.templates[`${this.templateId}`](this.component, {
            nodeManager: this,
            hasNodeManager: false, 
            index: i,
            parentId: this.parentId,
            position: this.tree,
            level: this.level,
            callback: (el, uuid) => {
              if (i === 0) {
                this.placeholder.replaceWith(el);
              } else {
                this.nodes[i-1].insertAdjacentElement('afterend', el);
              }
              this.nodes.push(el);
              this.component.nms[`${this.parentId} [${uuid}]`] = this;
            }, 
          });  
        }

      }
      NodeManager.prototype.addEventListeners = function() {};
      NodeManager.prototype.updateProps = function(dependency) {
        if (!this.requirement) return;
        this.requirement.map(([key, constructors]) => {
          const prop = this.props.find((prop) => prop.savedName === key);
          const isAny = constructors.includes(null);
          if (!prop && !isAny) {
            const UndefinedPropertyForComponentException = new Error(`[Ogone] ${key} is required as property but undefined in template. Please use following syntax\n\t\t<component :${key}="..."></component>`);
            throw UndefinedPropertyForComponentException;
          }
          const value = this.parentNodeManager.getContext({
            getText: `${prop.value}`,
            position: this.tree,
          });
          if ((value === undefined || value === null)  && !isAny) {
            const NullishPropertyException = new Error(`[Ogone] ${key} is required as property but can\'t be null. Please use following syntax\n\t\t<component :${key}="${constructors.join(' | ')}"></component>`);
            throw NullishPropertyException;
          }
          if (!constructors.includes(value.constructor.name)) {
            const PropertyDontMatchWithConstructorsException = new Error(`[Ogone] ${key} is required as property but it's value is not one of ${constructors.join(' | ')}`);
            throw PropertyDontMatchWithConstructorsException;
          }
          if (value !== this.component.data[key]) {
            this.component.data[key] = value;
            this.component.update(key);
          }
        })
      };
      NodeManager.prototype.update = function(dependency) {
        // manage NM states and force render
        this.updateProps(dependency);
        if (!(dependency instanceof Boolean) &&
          this.dependencies.length &&
          !this.dependencies.includes(dependency)) {
          return;
        }
        switch(true) {
          case this.state === 3 /* created */
            && !this.isRootNode:
            this.state = 1; /* inserted */
            this.setAmountOfNodes();
            this.render();
            this.getTexts();
            this.addEventListeners();
          break;
          case this.state === 1 && !this.isRootNode:
            this.setAmountOfNodes();
            this.render();
            this.getTexts();
            break;
          }
          this.updateChilds(dependency);
      }
      NodeManager.prototype.updateChilds = function(dependency) {
        this.childs.forEach((nmChild) => {
          if (nmChild.state === 0) return;
          nmChild.update(dependency);
        });
      }
      NodeManager.prototype.getTexts = function() {
        // get nm text
        Object.values(this.texts).forEach((text) => {
          const value = this.getContext({
            getText: `\`${text.rawText}\``,
            position: this.positions[text.uuid],
          });
          if (text.data !== value) {
            text.data = value;
          }
        })
      }
      NodeManager.prototype.setAmountOfNodes = function() {
        if (!this.getContext) return;
        this.amount = this.getContext({
          query: this.querySelector,
          getLength: true,
        });
      }
    </script>
    %%scripts%%
    <script>
      //%%on-open%%
      /*
        const $APPWS_REPLACED_VAR$___ = new WebSocket(`ws://${host}/%%id%%`);
        $APPWS_REPLACED_VAR$___.onopen = () => {
          
        };
        $APPWS_REPLACED_VAR$___.onclose = () => {
          location.reload();
        };
        $APPWS_REPLACED_VAR$___.onmessage = (event) => {
          if ($APPWS_REPLACED_VAR$___.readyState !== 1) return;
          if (event.data === 'reload') {
            location.reload();
            return;
          }
          const ev = JSON.parse(event.data);
          if (ev.id) {
            //
          }
        };
        */
      </script>
  </body>
</html>