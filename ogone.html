<html>
  <head> 
      %%styles%%
  </head>
  <body>
    <div id="app"></div>
    <script>
      const host = location.host;
      function OComponent(ws) {
        this.ws = ws;
        this.contexts = {};
        this.context = {};
        this.nms = {}; /* NodeManager{} */
        this.events = {}; /* events describers */
        this.arrays = {}; /* data describer o-for */
        this.send = (json) => {
          this.ws.send(JSON.stringify(json));
        };
        this.directRenders = {};
        this.texts = [];
        this.read = (ev) => {
          switch(ev.type) {
            case 'component':
                this.rootNode = document.querySelector(`${ev.querySelector}:not([${ev.attr}])`);
                this.id = ev.id;
                this.render(ev);
                this.runtime['o-init']();
              break;
          }
        }
        this.update = () => {
          const nms = Object.values(this.nms);
          nms.filter((nm) => nm.state).reverse().forEach((nm) => {
            nm.update();
          });
        }
        this.render = (item) => {
          if (!item) return;
          if (this.rootNode) {
            Ogone.templates[item.attr](this, {
              hasNodeManager: true,
              parentNodeManager: this,
              NodeManager: null,
              index: 0,
              level: 0,
              position: [0],
              querySelector: this.id,
              callback: (template) => {
                this.rootNode.replaceWith(...template.childNodes);
              },
            });
            this.update();
          }
        }
        this.renderElements = (html) => {
          const template = document.createElement('template');
          template.insertAdjacentHTML('beforeend', html);
          return Array.from(template.childNodes).filter((c) => c.nodeType !== 3);
        };
        this.renderDirectRender = (item) => {
          if (!item) return;
          if (this.directRenders[item.id2]) {
            const newel = this.renderElements(item.html)[0];
            this.directRenders[item.id2].replaceWith(newel);
            this.directRenders[item.id2] = newel;
            return;
          }
          if (item.querySelector === null) {
            const el = this.rootNode[0];
            const newel = this.renderElements(item.html)[0];
            el.replaceWith(newel);
            this.directRenders[item.id2] = newel;
            this.rootNode.slice(1).forEach((c) => c.remove());
            return;
          }
          this.rootNode.every((child) => {
            const el = child.querySelector(item.querySelector);
            if (el) {
              const newel = this.renderElements(item.html)[0];
              el.replaceWith(newel);
              this.directRenders[item.id2] = newel;
              return;
            }
          })
        }
        this.dr = (ref, html) => {
          try {
            if (ref.length && !this.refs[ref]) {
              return;
            }
            const querySelector = this.refs[ref] || false;
            let result = html;
            if (Array.isArray(html)) {
              result = html.join('');
            }
            if (html instanceof Function) {
              result = html();
            }
            const oElementId = `o-${(querySelector || '').trim().replace(/([^a-zA-Z0-9]*)+/gi, '') || ''}-rd`;
            this.renderDirectRender({
              id2: oElementId,
              html: result.replace(/%%id%%/gi, `${this.id} ${oElementId}`),
              querySelector: !!querySelector ? 
                `[${this.nms.root.templateId}][${this.id}] > ${querySelector.trim()}`:
                null,
              type: 'render',
              id: this.id,
            });
          } catch(e) {
            throw e;
          }
        };
        this.h = (name, attr, ...childs) => {
          try {
            let attrs = [];
            if (attr) {
              attrs = Object.entries(attr).map(([key, value]) => {
                if (key.startsWith('$')) {
                  return;
                }
                return `${key}="${value}"`
              })
            }
            const element = `<${name} %%id%% ${this.uuid} ${attrs.join(' ')}>${childs.flat().join(' ')}</${name}>`
            // direct rendering with $$ references
            if (attr) {
              const ref = Object.keys(attr).find((key) => key.startsWith('$'));
              if (ref) {
                const id = ref.slice(1);
                this.dr(id, element);
                return id;
              }
            }
            return element;
          } catch(e) {
            throw e;
          }
        };
      }

    </script>
    <script>
        const Ogone = {
          render: [],
          events: [],
          styles: [],
          templates: {},
          texts: [],
          contexts: {},
          components: {},
        };
    </script>
    <script>
      function NodeManager(component, node, opts) {
        this.state = 3;
          /*
            3 created
            2 paused
            1 node has parentNode
            0 dead
          */
        this.type = opts.type;
        this.isRootNode = !opts.querySelector.length;
        this.parentId = opts.parentId;
        this.templateId = opts.templateId;
        this.templateUuid = opts.templateUuid;
        this.querySelector = opts.querySelector;
        this.uuid = opts.uuid;
        this.component = component;
        this.node = node;
        this.nodes = [node];
        this.array = opts.array;
        this.componentUuid = opts.componentUuid;
        this.placeholder = new Comment('');
        this.position = `${this.parentId} [${this.uuid}]`;
        this.texts = {};
        this.getContext = null;
        this.tree = opts.position;
        this.level = opts.level;
        this.positions = {};
        this.amount = 1;
        this.childs = [];
        if (this.isRootNode) {
          this.component.nms.root = this;
        } else {
          if (this.component.nms[this.position]) {
            this.component.nms[this.position].state = 0
            console.warn(this.component.nms[this.position], this);
          }
          this.component.nms[this.position] = this;
        }
      }
      NodeManager.prototype.render = function() {
        if (this.state !== 1 || this.amount === undefined) return;
        for (let i = this.nodes.length, a = this.amount; i > a; i--) {
          if (this.nodes.length === 1) {
            const firstEl = this.nodes[0];
            if (firstEl) {
              const { parentNode } = firstEl;
              parentNode.insertBefore(this.placeholder, firstEl);
            }
          }
          const removedEl = this.nodes.pop();
          removedEl.remove();
        }
        if (this.nodes.length < this.amount) {
          if (this.nodes.length === 1) {
            this.nodes[0].replaceWith(this.placeholder);
            this.nodes[0].remove();
            this.nodes.shift();
          }
        }
        for (let i = this.nodes.length, a = this.amount;i < a; i++) {
          Ogone.templates[`${this.templateId}`](this.component, {
            nodeManager: this,
            hasNodeManager: false, 
            index: i,
            parentId: this.parentId,
            position: this.tree,
            level: this.level,
            callback: (el, uuid) => {
              if (i === 0) {
                this.placeholder.replaceWith(el);
              } else {
                this.nodes[i-1].insertAdjacentElement('afterend', el);
              }
              this.nodes.push(el);
              this.component.nms[`${this.parentId} [${uuid}]`] = this;
            }, 
          });  
        }

      }
      NodeManager.prototype.addEventListeners = function() {};
      NodeManager.prototype.update = function() {
        // manage NM states and force render
        switch(true) {
          case this.state === 3 /* created */
            && !this.isRootNode:
            this.state = 1; /* inserted */
            this.setAmountOfNodes();
            this.render();
            this.getTexts();
            this.addEventListeners();
            this.updateChilds();
          break;
          case this.state === 1 && !this.isRootNode:
            this.setAmountOfNodes();
            this.render();
            this.getTexts();
            this.updateChilds();
          break;
        }
      }
      NodeManager.prototype.updateChilds = function() {
        this.childs.forEach((nmChild) => {
          if (nmChild.state === 0) return;
          nmChild.update();
        });
      }
      NodeManager.prototype.getTexts = function() {
        // get nm text
        Object.values(this.texts).forEach((text) => {
          const value = this.getContext({
            getText: `\`${text.rawText}\``,
            position: this.positions[text.uuid],
          });
          if (text.data !== value) {
            text.data = value;
          }
        })
      }
      NodeManager.prototype.setAmountOfNodes = function() {
        this.amount = this.getContext({
          getLength: true,
        });
      }
    </script>
    %%scripts%%
    <script>
        const $APPWS_REPLACED_VAR$___ = new WebSocket(`ws://${host}/%%id%%`);
        $APPWS_REPLACED_VAR$___.onopen = () => {
          //%%on-open%%
        };
        $APPWS_REPLACED_VAR$___.onclose = () => {
          location.reload();
        };
        $APPWS_REPLACED_VAR$___.onmessage = (event) => {
          if ($APPWS_REPLACED_VAR$___.readyState !== 1) return;
          if (event.data === 'reload') {
            location.reload();
            return;
          }
          const ev = JSON.parse(event.data);
          if (ev.id) {
            //
          }
        };
      </script>
  </body>
</html>